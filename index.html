<html>
<head>
    <title>Ordenes De Servicio RRScooters CDMX ( Condesa )</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #470089;
        }
        .calculator {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #4f02a2;
            text-align: center;
            margin-bottom: 50px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, button, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        .results {
            margin-top: 20px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        .delete-btn {
            background-color: #f44336;
            padding: 5px 10px;
            width: auto;
        }
        .summary-card {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .tab {
            padding: 10px 20px;
            background-color: #ddd;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            white-space: nowrap;
            display: flex;
            align-items: center;
        }
        .tab i {
            margin-right: 8px;
        }
        .tab.active {
            background-color: #6406e9;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .export-btn {
            background-color: #2196F3;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .export-btn i {
            margin-right: 8px;
        }
        .export-btn:hover {
            background-color: #0b7dda;
        }
        .notes-btn {
            background-color: #FF9800;
            padding: 5px 10px;
            width: auto;
            display: flex;
            align-items: center;
        }
        .notes-btn i {
            margin-right: 5px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 700px;
            border-radius: 5px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .notes-display {
            background-color: #fffde7;
            padding: 10px;
            border-left: 4px solid #FFC107;
            margin: 10px 0;
        }
        .status-select {
            width: auto;
            margin-left: 10px;
        }
        .status-completed {
            background-color: #e8f5e9;
        }
        .status-pending {
            background-color: #fff3e0;
        }
        .status-repair {
            background-color: #ffebee;
        }
        .customer-info {
            background-color: #e3f2fd;
            padding: 10px;
            border-left: 4px solid #2196F3;
            margin: 10px 0;
        }
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #470089;
        }
        .login-box {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 300px;
            text-align: center;
        }
        .login-box h2 {
            margin-top: 0;
            color: #333;
        }
        .login-box input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .login-box button {
            width: 100%;
            padding: 10px;
            background-color: #6406e9;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .login-box button:hover {
            background-color: #6406e9;
        }
        .error-message {
            color: #f44336;
            margin-top: 10px;
            font-size: 14px;
        }
        .restricted-action {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        .header-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .logo-container {
            margin-bottom: 10px;
        }
        .logo-container img {
            max-width: 250px;
            height: auto;
        }
        .copyright {
            text-align: center;
            margin-top: 10px;
            font-size: 12px;
            color: #40084b;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        .chart-title {
            text-align: center;
            margin: 15px 0 5px;
            font-weight: bold;
        }
        .serial-number-group {
            display: flex;
            align-items: center;
        }
        .serial-number-group input {
            flex: 1;
            margin-right: 10px;
        }
        .serial-number-group select {
            width: 80px;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .action-buttons button {
            margin-top: 0;
        }
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .stats-box {
            flex: 1;
            min-width: 300px;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .phone-link {
            color: #25D366;
            text-decoration: none;
            cursor: pointer;
        }
        .phone-link:hover {
            text-decoration: underline;
        }
        .phone-container {
            display: flex;
            align-items: center;
        }
        .monthly-service-card {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .monthly-service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }
        .monthly-service-title {
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }
        .monthly-service-total {
            font-weight: bold;
            color: #4CAF50;
        }

        /* Nuevos estilos para notas pendientes */
        .pending-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .pending-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            border-left: 4px solid;
            transition: transform 0.2s;
        }
        
        .pending-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(230, 163, 163, 0.15);
        }
        
        .pending-card.completed {
            border-left-color: #15ff00;
        }
        
        .pending-card.pending {
            border-left-color: #6406e9;
        }
        
        .pending-card.repair {
            border-left-color: #ff0000;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .card-title {
            font-weight: bold;
            font-size: 16px;
            margin: 0;
            color: #333;
        }
        
        .card-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
        }
        
        .status-completed {
            background-color: #4CAF50;
        }
        
        .status-pending {
            background-color: #FF9800;
        }
        
        .status-repair {
            background-color: #f44336;
        }
        
        .card-details {
            font-size: 13px;
            color: #555;
            margin-bottom: 8px;
        }
        
        .card-details p {
            margin: 4px 0;
            display: flex;
            align-items: center;
        }
        
        .card-details i {
            width: 20px;
            text-align: center;
            margin-right: 5px;
            color: #666;
        }
        
        .card-notes {
            font-size: 13px;
            background-color: #f9f9f9;
            padding: 8px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 3px solid #FFC107;
        }
        
        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .card-actions button {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }
        
        .card-actions button i {
            margin-right: 5px;
        }

        /* Estilos mejorados para la tabla de inventario */
        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .inventory-table th, .inventory-table td {
            padding: 8px 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        
        .inventory-table th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        
        .inventory-item:hover {
            background-color: #f9f9f9;
        }
        
        .low-stock {
            background-color: #fff3e0;
        }
        
        .critical-stock {
            background-color: #ffebee;
            font-weight: bold;
        }
        
        .out-stock {
            background-color: #ffcdd2;
            font-weight: bold;
            color: #c62828;
        }
        
        .inventory-actions {
            display: flex;
            gap: 5px;
        }
        
        .inventory-actions button {
            padding: 5px 10px;
            font-size: 12px;
            margin-top: 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .inventory-actions button i {
            margin-right: 5px;
        }
        
        .btn-primary {
            background-color: #4e73df;
            color: white;
        }
        
        .btn-success {
            background-color: #1cc88a;
            color: white;
        }
        
        .btn-info {
            background-color: #36b9cc;
            color: white;
        }
        
        .btn-warning {
            background-color: #f6c23e;
            color: white;
        }
        
        .btn-danger {
            background-color: #e74a3b;
            color: white;
        }
        
        .text-success {
            color: #1cc88a;
            font-weight: bold;
        }
        
        .text-danger {
            color: #e74a3b;
            font-weight: bold;
        }
        
        .percentage-bar-container {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .percentage-bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .percentage-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            font-weight: bold;
            color: #333;
        }
        
        .inventory-summary {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .summary-item {
            display: flex;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
        }
        
        .summary-item i {
            margin-right: 8px;
            font-size: 18px;
        }
        
        .total-items i {
            color: #4e73df;
        }
        
        .low-stock i {
            color: #f6c23e;
        }
        
        .critical-stock i {
            color: #e74a3b;
        }
        
        .out-of-stock i {
            color: #c62828;
        }
        
        .total-value i {
            color: #1cc88a;
        }
        
        .table-responsive {
            overflow-x: auto;
        }
        
        .movements-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .movements-table th, .movements-table td {
            padding: 8px 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        
        .movements-table th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        
        .movement-entrada {
            background-color: rgba(28, 200, 138, 0.1);
        }
        
        .movement-salida {
            background-color: rgba(231, 74, 59, 0.1);
        }
        
        .movement-ajuste {
            background-color: rgba(54, 185, 204, 0.1);
        }
        
        .filters-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .filters-container .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .filters-container select {
            width: auto;
            min-width: 150px;
        }

        /* Estilos para la tabla de logs */
        #logsTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        #logsTable th, #logsTable td {
            padding: 8px 12px;
            border: 1px solid #ddd;
            text-align: left;
        }

        #logsTable th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }

        .log-entry {
            font-size: 13px;
        }

        .log-info {
            background-color: #e7f4ff;
        }

        .log-warning {
            background-color: #fff3e0;
        }

        .log-error {
            background-color: #ffebee;
        }

        .log-critical {
            background-color: #fce4ec;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <div class="logo-container">
                <img src="https://i.ibb.co/Sz0bFV1/logo.png" alt="RR Scooters Logo">
            </div>
            <h2>Iniciar Sesión</h2>
            <input type="text" id="username" placeholder="Usuario" required>
            <input type="password" id="password" placeholder="Contraseña" required>
            <button onclick="checkLogin()"><i class="fas fa-sign-in-alt"></i> Acceder</button>
            <div id="loginError" class="error-message"></div>
        </div>
    </div>
    
    <div id="mainContainer" class="calculator" style="display: none;">
        <div class="header-container">
            <div class="logo-container">
                <img src="https://i.ibb.co/Sz0bFV1/logo.png" alt="RR Scooters Logo">
            </div>
            <h1><i class="fas fa-tools"></i>Orden De Servicio R.R</h1>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('venta')"><i class="fas fa-plus-circle"></i> Nueva Reparación</div>
            <div class="tab" onclick="switchTab('historico')"><i class="fas fa-history"></i> Historial</div>
            <div class="tab" onclick="switchTab('resumen')"><i class="fas fa-chart-pie"></i> Resumen</div>
            <div class="tab" onclick="switchTab('notas')"><i class="fas fa-clipboard-list"></i> Notas Pendientes</div>
            <div class="tab" onclick="switchTab('estadisticas')"><i class="fas fa-chart-line"></i> Estadísticas</div>
            <div class="tab" onclick="switchTab('mensual')"><i class="fas fa-calendar-alt"></i> Servicios por Mes</div>
            <div class="tab" onclick="switchTab('inventario')"><i class="fas fa-boxes"></i> Inventario</div>
            <div class="tab" onclick="switchTab('logs')"><i class="fas fa-clipboard-check"></i> Registro de Actividades</div>
        </div>
        
        <!-- Pestaña de Nueva Reparación -->
        <div id="venta" class="tab-content active">
            <div class="form-group">
                <label for="customerName"><i class="fas fa-user"></i> Nombre del Cliente:</label>
                <input type="text" id="customerName" placeholder="Nombre completo del cliente" required>
            </div>
            
            <div class="form-group">
                <label for="customerPhone"><i class="fas fa-phone"></i> Teléfono del Cliente:</label>
                <input type="tel" id="customerPhone" placeholder="10 dígitos (opcional)">
            </div>
            
            <div class="form-group">
                <label for="itemName"><i class="fas fa-motorcycle"></i> Modelo de Scooter:</label>
                <input type="text" id="itemName" placeholder="Modelo de la scooter" required>
            </div>
            
            <div class="form-group serial-number-group">
                <label for="serialNumber"><i class="fas fa-barcode"></i> Número de Serie:</label>
                <div style="display: flex; width: 100%;">
                    <input type="text" id="serialNumber" placeholder="Número de serie">
                    <select id="serialNumberOption" onchange="toggleSerialNumber()">
                        <option value="has">Tiene Serie</option>
                        <option value="none">No Tiene</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="repairCost"><i class="fas fa-dollar-sign"></i> Costo de Reparación ($):</label>
                <input type="number" id="repairCost" placeholder="0.00" step="0.01" min="0" required>
            </div>
            
            <div class="form-group">
                <label for="commissionRate"><i class="fas fa-percentage"></i> Porcentaje de Comisión (%):</label>
                <input type="number" id="commissionRate" placeholder="10" value="10" min="0" max="100" required>
            </div>
            
            <div class="form-group">
                <label for="salesPerson"><i class="fas fa-user-tie"></i> Técnico:</label>
                <select id="salesPerson" required>
                    <option value="">Seleccione un técnico</option>
                    <option value="Ricardo">Ricardo Meza/ "El Hadas""</option>
                    <option value="Hugo Cerón">Hugo Cerón "El Flaco"</option>
                    <option value="Luiggi">Luiggi "El Pelito Largo"</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="saleDate"><i class="fas fa-calendar-alt"></i> Fecha:</label>
                <input type="date" id="saleDate" required>
            </div>
            
            <div class="form-group">
                <label for="repairStatus"><i class="fas fa-info-circle"></i> Estado:</label>
                <select id="repairStatus" required>
                    <option value="completed">Completado</option>
                    <option value="pending" selected>Pendiente</option>
                    <option value="repair">En Reparación</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="repairNotes"><i class="fas fa-sticky-note"></i> Notas de Reparación:</label>
                <textarea id="repairNotes" placeholder="Detalles de la reparación, problemas encontrados, etc."></textarea>
            </div>
            
            <button id="addItem" onclick="addItem()"><i class="fas fa-save"></i> Guardar Orden</button>
        </div>
        
        <!-- Pestaña de Historial -->
        <div id="historico" class="tab-content">
            <div class="form-group">
                <input type="text" id="searchInput" placeholder="Buscar por cliente, modelo, técnico o estado...">
            </div>
            
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Teléfono</th>
                            <th>Modelo</th>
                            <th>Costo</th>
                            <th>Comisión</th>
                            <th>Técnico</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- El historial se cargará aquí -->
                    </tbody>
                </table>
            </div>
            
            <button onclick="exportToCSV()" class="export-btn"><i class="fas fa-file-excel"></i> Exportar a CSV</button>
            <button onclick="exportToPDF()" class="export-btn"><i class="fas fa-file-pdf"></i> Exportar a PDF</button>
        </div>
        
        <!-- Pestaña de Resumen -->
        <div id="resumen" class="tab-content">
            <div class="summary-card">
                <h3><i class="fas fa-chart-bar"></i> Resumen General</h3>
                <div class="stats-container">
                    <div class="stats-box">
                        <p><i class="fas fa-dollar-sign"></i> <strong>Total Ventas:</strong> $<span id="totalSales">0.00</span></p>
                        <p><i class="fas fa-hand-holding-usd"></i> <strong>Total Comisiones:</strong> $<span id="totalCommissions">0.00</span></p>
                    </div>
                    <div class="stats-box">
                        <p><i class="fas fa-motorcycle"></i> <strong>Scooters Atendidos:</strong> <span id="totalUnits">0</span></p>
                        <p><i class="fas fa-users"></i> <strong>Clientes Únicos:</strong> <span id="totalCustomers">0</span></p>
                    </div>
                    <div class="stats-box">
                        <p><i class="fas fa-check-circle" style="color: #4CAF50;"></i> <strong>Completados:</strong> <span id="completedCount">0</span></p>
                        <p><i class="fas fa-clock" style="color: #FF9800;"></i> <strong>Pendientes:</strong> <span id="pendingCount">0</span></p>
                        <p><i class="fas fa-tools" style="color: #f44336;"></i> <strong>En Reparación:</strong> <span id="repairCount">0</span></p>
                    </div>
                </div>
            </div>
            
            <div class="summary-card">
                <h3><i class="fas fa-user-tie"></i> Resumen por Técnico</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Técnico</th>
                            <th>Ventas</th>
                            <th>Comisiones</th>
                            <th>Clientes</th>
                        </tr>
                    </thead>
                    <tbody id="salesByPersonBody">
                        <!-- Los datos por técnico se cargarán aquí -->
                    </tbody>
                </table>
            </div>
            
            <div class="summary-card">
                <h3><i class="fas fa-motorcycle"></i> Resumen por Modelo</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Modelo</th>
                            <th>Unidades</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="salesByModelBody">
                        <!-- Los datos por modelo se cargarán aquí -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pestaña de Notas Pendientes -->
        <div id="notas" class="tab-content">
            <div class="form-group">
                <input type="text" id="searchNotesInput" placeholder="Buscar por cliente, modelo, técnico o notas...">
            </div>
            
            <div id="pendingRepairs" class="pending-cards-container">
                <!-- Las tarjetas de notas pendientes se cargarán aquí -->
            </div>
        </div>
        
        <!-- Pestaña de Estadísticas -->
        <div id="estadisticas" class="tab-content">
            <div class="stats-container">
                <div class="stats-box">
                    <h4 class="chart-title">Reparaciones por Semana (Últimas 8 semanas)</h4>
                    <div class="chart-container">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>
                
                <div class="stats-box">
                    <h4 class="chart-title">Reparaciones por Mes (Últimos 6 meses)</h4>
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="stats-container">
                <div class="stats-box">
                    <h4 class="chart-title">Estado de las Reparaciones</h4>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
                
                <div class="stats-box">
                    <h4 class="chart-title">Modelos Más Atendidos (Top 5)</h4>
                    <div class="chart-container">
                        <canvas id="modelsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pestaña de Servicios por Mes -->
        <div id="mensual" class="tab-content">
            <div id="monthlyServicesContainer">
                <!-- Los servicios mensuales se cargarán aquí -->
            </div>
        </div>
        
        <!-- Pestaña de Inventario -->
        <div id="inventario" class="tab-content">
            <h3><i class="fas fa-boxes"></i> Gestión de Inventario</h3>
            
            <!-- Filtros avanzados -->
            <div class="filters-container">
                <div class="form-group">
                    <input type="text" id="searchInventoryInput" placeholder="Buscar por nombre, categoría o descripción...">
                </div>
                <select id="categoryFilter" class="form-group">
                    <option value="">Todas las categorías</option>
                    <option value="herramientas">Herramientas</option>
                    <option value="refacciones">Refacciones</option>
                    <option value="consumibles">Consumibles</option>
                    <option value="electronicos">Componentes Electrónicos</option>
                    <option value="otros">Otros</option>
                </select>
                <select id="stockFilter" class="form-group">
                    <option value="">Todo el stock</option>
                    <option value="low">Stock bajo</option>
                    <option value="critical">Stock crítico</option>
                    <option value="out">Agotados</option>
                </select>
            </div>
            
            <!-- Barra de acciones -->
            <div class="action-buttons" style="margin-bottom: 15px;">
                <button onclick="openAddItemModal()" class="btn-primary"><i class="fas fa-plus"></i> Agregar Item</button>
                <button onclick="exportInventoryToCSV()" class="btn-success"><i class="fas fa-file-excel"></i> Exportar a Excel</button>
                <button onclick="generateInventoryReport()" class="btn-info"><i class="fas fa-file-pdf"></i> Reporte PDF</button>
                <button onclick="showInventoryStats()" class="btn-warning"><i class="fas fa-chart-bar"></i> Estadísticas</button>
            </div>
            
            <!-- Tabla de inventario con columnas adicionales -->
            <div class="table-responsive">
                <table id="inventoryTable" class="inventory-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-tag"></i> Nombre</th>
                            <th><i class="fas fa-list"></i> Categoría</th>
                            <th><i class="fas fa-hashtag"></i> Cantidad</th>
                            <th><i class="fas fa-dollar-sign"></i> Precio Unitario</th>
                            <th><i class="fas fa-barcode"></i> Código</th>
                            <th><i class="fas fa-boxes"></i> Stock Mínimo</th>
                            <th><i class="fas fa-percentage"></i> % Stock</th>
                            <th><i class="fas fa-cog"></i> Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody">
                        <!-- El inventario se cargará aquí -->
                    </tbody>
                </table>
            </div>
            
            <!-- Resumen rápido del inventario -->
            <div class="inventory-summary">
                <div class="summary-item total-items">
                    <i class="fas fa-box-open"></i>
                    <span id="totalItems">0</span> items
                </div>
                <div class="summary-item low-stock">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="lowStockItems">0</span> bajo stock
                </div>
                <div class="summary-item critical-stock">
                    <i class="fas fa-times-circle"></i>
                    <span id="criticalStockItems">0</span> crítico
                </div>
                <div class="summary-item out-of-stock">
                    <i class="fas fa-box"></i>
                    <span id="outOfStockItems">0</span> agotados
                </div>
                <div class="summary-item total-value">
                    <i class="fas fa-dollar-sign"></i>
                    $<span id="totalInventoryValue">0.00</span>
                </div>
            </div>
            
            <!-- Historial de movimientos con más detalles -->
            <h4 style="margin-top: 30px;"><i class="fas fa-exchange-alt"></i> Historial de Movimientos</h4>
            <div class="form-group">
                <input type="text" id="searchMovementsInput" placeholder="Buscar por item, usuario, tipo o notas...">
            </div>
            <div class="table-responsive">
                <table id="movementsTable" class="movements-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-calendar-alt"></i> Fecha/Hora</th>
                            <th><i class="fas fa-tag"></i> Item</th>
                            <th><i class="fas fa-exchange-alt"></i> Tipo</th>
                            <th><i class="fas fa-hashtag"></i> Cantidad</th>
                            <th><i class="fas fa-user"></i> Usuario</th>
                            <th><i class="fas fa-comment"></i> Notas</th>
                            <th><i class="fas fa-boxes"></i> Stock Actual</th>
                        </tr>
                    </thead>
                    <tbody id="movementsTableBody">
                        <!-- El historial de movimientos se cargará aquí -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pestaña de Registro de Actividades -->
        <div id="logs" class="tab-content">
            <div class="form-group">
                <input type="text" id="searchLogsInput" placeholder="Buscar por usuario, acción o fecha...">
            </div>
            
            <div class="table-responsive">
                <table id="logsTable">
                    <thead>
                        <tr>
                            <th>Fecha/Hora</th>
                            <th>Usuario</th>
                            <th>Acción</th>
                            <th>Detalles</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody">
                        <!-- Los logs se cargarán aquí -->
                    </tbody>
                </table>
            </div>
            
            <div class="action-buttons" style="margin-top: 15px;">
                <button onclick="exportLogsToCSV()" class="export-btn"><i class="fas fa-file-excel"></i> Exportar a CSV</button>
                <button onclick="clearLogs()" class="delete-btn"><i class="fas fa-trash-alt"></i> Limpiar Registros</button>
            </div>
        </div>
        
        <div class="copyright">
            <p><i class="far fa-copyright"></i> Todos Los Derechos Reservados &copy; R.R SCooters 2025 Por Arturo Tramontin</p>
        </div>
    </div>

    <!-- Modal para ver/editar notas -->
    <div id="notesModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modalTitle"><i class="fas fa-sticky-note"></i> Notas de Reparación</h3>
            <div class="customer-info">
                <p><i class="fas fa-user"></i> <strong>Cliente:</strong> <span id="modalCustomer"></span></p>
                <p><i class="fas fa-phone"></i> <strong>Teléfono:</strong> <span id="modalPhone"></span></p>
                <p><i class="fas fa-motorcycle"></i> <strong>Modelo:</strong> <span id="modalModel"></span></p>
                <p><i class="fas fa-barcode"></i> <strong>Número de Serie:</strong> <span id="modalSerial"></span></p>
                <p><i class="fas fa-calendar-alt"></i> <strong>Fecha:</strong> <span id="modalDate"></span></p>
                <p><i class="fas fa-user-tie"></i> <strong>Técnico:</strong> <span id="modalTech"></span></p>
            </div>
            <div class="form-group">
                <label for="modalCost"><i class="fas fa-dollar-sign"></i> Costo de Reparación ($):</label>
                <input type="number" id="modalCost" placeholder="0.00" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label for="modalStatus"><i class="fas fa-info-circle"></i> Estado:</label>
                <select id="modalStatus" class="status-select">
                    <option value="completed">Completado</option>
                    <option value="pending">Pendiente</option>
                    <option value="repair">En Reparación</option>
                </select>
            </div>
            <div class="form-group">
                <label for="modalNotes"><i class="fas fa-sticky-note"></i> Notas:</label>
                <textarea id="modalNotes"></textarea>
            </div>
            <button id="saveNotesBtn" onclick="saveNotesChanges()"><i class="fas fa-save"></i> Guardar Cambios</button>
        </div>
    </div>

    <!-- Modal para agregar/editar herramientas -->
    <div id="inventoryModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeInventoryModal()">&times;</span>
            <h3 id="inventoryModalTitle"><i class="fas fa-box"></i> Agregar Herramienta</h3>
            
            <div class="form-group">
                <label for="itemNameInventory"><i class="fas fa-tag"></i> Nombre:</label>
                <input type="text" id="itemNameInventory" placeholder="Ej. Llave Allen 5mm">
            </div>
            
            <div class="form-group">
                <label for="itemCategory"><i class="fas fa-list"></i> Categoría:</label>
                <select id="itemCategory">
                    <option value="herramientas">Herramientas</option>
                    <option value="refacciones">Refacciones</option>
                    <option value="consumibles">Consumibles</option>
                    <option value="electronicos">Componentes Electrónicos</option>
                    <option value="otros">Otros</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="itemQuantity"><i class="fas fa-hashtag"></i> Cantidad Inicial:</label>
                <input type="number" id="itemQuantity" value="1" min="0">
            </div>
            
            <div class="form-group">
                <label for="itemPrice"><i class="fas fa-dollar-sign"></i> Precio Unitario ($):</label>
                <input type="number" id="itemPrice" placeholder="0.00" step="0.01" min="0">
            </div>
            
            <div class="form-group">
                <label for="itemCode"><i class="fas fa-barcode"></i> Código/Número de Parte:</label>
                <input type="text" id="itemCode" placeholder="Opcional">
            </div>
            
            <div class="form-group">
                <label for="itemDescription"><i class="fas fa-align-left"></i> Descripción:</label>
                <textarea id="itemDescription" placeholder="Detalles adicionales sobre la herramienta"></textarea>
            </div>
            
            <div class="form-group">
                <label for="itemMinStock"><i class="fas fa-exclamation-triangle"></i> Stock Mínimo:</label>
                <input type="number" id="itemMinStock" value="1" min="0" placeholder="Cantidad mínima antes de alertar">
            </div>
            
            <button onclick="saveInventoryItem()"><i class="fas fa-save"></i> Guardar</button>
        </div>
    </div>

    <!-- Modal para movimientos de inventario -->
    <div id="movementModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeMovementModal()">&times;</span>
            <h3 id="movementModalTitle"><i class="fas fa-exchange-alt"></i> Movimiento de Inventario</h3>
            
            <div class="form-group">
                <label for="movementType"><i class="fas fa-exchange-alt"></i> Tipo de Movimiento:</label>
                <select id="movementType" onchange="toggleMovementFields()">
                    <option value="entrada">Entrada</option>
                    <option value="salida">Salida</option>
                    <option value="ajuste">Ajuste</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="movementQuantity"><i class="fas fa-hashtag"></i> Cantidad:</label>
                <input type="number" id="movementQuantity" value="1" min="1">
            </div>
            
            <div class="form-group" id="movementTechnicianGroup" style="display: none;">
                <label for="movementTechnician"><i class="fas fa-user-tie"></i> Técnico:</label>
                <select id="movementTechnician">
                    <option value="">Seleccione un técnico</option>
                    <option value="Ricardo">Ricardo Meza</option>
                    <option value="Hugo Cerón">Hugo Cerón</option>
                    <option value="Luiggi">Luiggi</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="movementNotes"><i class="fas fa-sticky-note"></i> Notas:</label>
                <textarea id="movementNotes" placeholder="Motivo del movimiento, detalles, etc."></textarea>
            </div>
            
            <button onclick="saveInventoryMovement()"><i class="fas fa-save"></i> Registrar Movimiento</button>
        </div>
    </div>

    <!-- Modal para estadísticas de inventario -->
    <div id="inventoryStatsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeInventoryStatsModal()">&times;</span>
            <h3><i class="fas fa-chart-pie"></i> Estadísticas de Inventario</h3>
            
            <div class="stats-container" style="display: flex; flex-wrap: wrap; gap: 20px;">
                <div class="stats-box" style="flex: 1; min-width: 300px;">
                    <h4 class="chart-title">Distribución por Categoría</h4>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="inventoryCategoryChart"></canvas>
                    </div>
                </div>
                
                <div class="stats-box" style="flex: 1; min-width: 300px;">
                    <h4 class="chart-title">Items con Stock Bajo</h4>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="inventoryLowStockChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="stats-table" style="margin-top: 20px;">
                <h4 class="chart-title">Top 10 Items Más Movidos</h4>
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Entradas</th>
                            <th>Salidas</th>
                            <th>Movimientos</th>
                        </tr>
                    </thead>
                    <tbody id="topMovedItemsBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let salesHistory = JSON.parse(localStorage.getItem('scooterSales')) || [];
        let inventory = JSON.parse(localStorage.getItem('scooterInventory')) || [];
        let inventoryMovements = JSON.parse(localStorage.getItem('inventoryMovements')) || [];
        let activityLogs = JSON.parse(localStorage.getItem('activityLogs')) || [];
        let commissionRate = 10;
        let currentEditingId = null;
        let currentInventoryItemId = null;
        let currentUser = null;
        let weeklyChart, monthlyChart, statusChart, modelsChart;
        let inventoryCategoryChart, inventoryLowStockChart;
        
        // Elementos del DOM
        const customerNameInput = document.getElementById('customerName');
        const customerPhoneInput = document.getElementById('customerPhone');
        const itemNameInput = document.getElementById('itemName');
        const serialNumberInput = document.getElementById('serialNumber');
        const serialNumberOption = document.getElementById('serialNumberOption');
        const repairCostInput = document.getElementById('repairCost');
        const commissionRateInput = document.getElementById('commissionRate');
        const salesPersonInput = document.getElementById('salesPerson');
        const saleDateInput = document.getElementById('saleDate');
        const repairStatusInput = document.getElementById('repairStatus');
        const repairNotesInput = document.getElementById('repairNotes');
        const addItemBtn = document.getElementById('addItem');
        const searchInput = document.getElementById('searchInput');
        const searchNotesInput = document.getElementById('searchNotesInput');
        const searchInventoryInput = document.getElementById('searchInventoryInput');
        const searchMovementsInput = document.getElementById('searchMovementsInput');
        const searchLogsInput = document.getElementById('searchLogsInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const stockFilter = document.getElementById('stockFilter');
        const historyTableBody = document.getElementById('historyTableBody');
        const pendingRepairsDiv = document.getElementById('pendingRepairs');
        const inventoryTableBody = document.getElementById('inventoryTableBody');
        const movementsTableBody = document.getElementById('movementsTableBody');
        const logsTableBody = document.getElementById('logsTableBody');
        const modal = document.getElementById('notesModal');
        const inventoryModal = document.getElementById('inventoryModal');
        const movementModal = document.getElementById('movementModal');
        const inventoryStatsModal = document.getElementById('inventoryStatsModal');
        const closeModal = document.getElementsByClassName('close')[0];
        const saveNotesBtn = document.getElementById('saveNotesBtn');
        const monthlyServicesContainer = document.getElementById('monthlyServicesContainer');
        
        // Usuarios válidos
        const validUsers = {
            'Arturo': '8585',
            'Ventas': '1234'
        };
        
        // Función para registrar una actividad
        function logActivity(action, details, level = 'info') {
            const logEntry = {
                timestamp: new Date().toISOString(),
                user: currentUser,
                action: action,
                details: details,
                level: level
            };
            
            activityLogs.push(logEntry);
            localStorage.setItem('activityLogs', JSON.stringify(activityLogs));
            
            // Si estamos en la pestaña de logs y el usuario es Arturo, actualizar la tabla
            if (currentUser === 'Arturo' && document.getElementById('logs').classList.contains('active')) {
                loadLogs();
            }
        }
        
        // Función para cargar los logs
        function loadLogs() {
            const searchTerm = searchLogsInput.value.toLowerCase();
            
            // Filtrar logs según el término de búsqueda
            const filteredLogs = activityLogs.filter(log => 
                log.user.toLowerCase().includes(searchTerm) ||
                log.action.toLowerCase().includes(searchTerm) ||
                log.details.toLowerCase().includes(searchTerm) ||
                log.timestamp.toLowerCase().includes(searchTerm)
            ).reverse(); // Mostrar los más recientes primero
            
            logsTableBody.innerHTML = '';
            
            if (filteredLogs.length === 0) {
                logsTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No se encontraron registros</td></tr>';
                return;
            }
            
            filteredLogs.forEach(log => {
                const row = document.createElement('tr');
                row.className = `log-entry log-${log.level}`;
                
                const dateCell = document.createElement('td');
                dateCell.textContent = formatDateTime(log.timestamp);
                
                const userCell = document.createElement('td');
                userCell.textContent = log.user;
                
                const actionCell = document.createElement('td');
                actionCell.textContent = log.action;
                
                const detailsCell = document.createElement('td');
                detailsCell.textContent = log.details;
                
                row.appendChild(dateCell);
                row.appendChild(userCell);
                row.appendChild(actionCell);
                row.appendChild(detailsCell);
                
                logsTableBody.appendChild(row);
            });
        }
        
        // Función para exportar logs a CSV
        function exportLogsToCSV() {
            if (activityLogs.length === 0) {
                alert('No hay registros para exportar');
                return;
            }
            
            let csv = 'Fecha/Hora,Usuario,Acción,Detalles,Nivel\n';
            
            activityLogs.forEach(log => {
                csv += `"${formatDateTime(log.timestamp)}","${log.user}","${log.action}","${log.details.replace(/"/g, '""')}","${log.level}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `registro_actividades_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Función para limpiar logs
        function clearLogs() {
            if (confirm('¿Está seguro que desea borrar todos los registros de actividad? Esta acción no se puede deshacer.')) {
                activityLogs = [];
                localStorage.setItem('activityLogs', JSON.stringify(activityLogs));
                loadLogs();
                logActivity('LIMPIEZA DE LOGS', 'Todos los registros de actividad fueron eliminados', 'critical');
            }
        }
        
        // Función para verificar el login
        function checkLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('loginError');
            
            if (validUsers[username] && validUsers[username] === password) {
                currentUser = username;
                logActivity('INICIO DE SESIÓN', `Usuario ${username} inició sesión`, 'info');
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                
                // Configurar fecha actual por defecto
                const today = new Date().toISOString().split('T')[0];
                saleDateInput.value = today;
                loadSalesHistory();
                updateSummary();
                loadPendingNotes();
                updateCharts();
                loadMonthlyServices();
                loadInventory();
                
                // Aplicar restricciones según el tipo de usuario
                applyUserRestrictions();
            } else {
                logActivity('INTENTO DE INICIO DE SESIÓN FALLIDO', `Intento fallido con usuario: ${username}`, 'warning');
                errorElement.textContent = 'Usuario o contraseña incorrectos';
            }
        }
        
        // Función para alternar el campo de número de serie
        function toggleSerialNumber() {
            if (serialNumberOption.value === 'none') {
                serialNumberInput.value = 'N/A';
                serialNumberInput.disabled = true;
            } else {
                serialNumberInput.value = '';
                serialNumberInput.disabled = false;
                serialNumberInput.focus();
            }
        }
        
        // Función para formatear número de teléfono con enlace a WhatsApp
        function formatPhoneNumber(phone) {
            if (!phone || phone === 'N/A') return 'N/A';
            
            // Limpiar número (quitar espacios, guiones, paréntesis)
            const cleanPhone = phone.replace(/[\s\-()]/g, '');
            
            // Formatear como (XXX) XXX-XXXX si tiene 10 dígitos y crear enlace a WhatsApp
            if (cleanPhone.length === 10) {
                const formatted = `(${cleanPhone.substring(0, 3)}) ${cleanPhone.substring(3, 6)}-${cleanPhone.substring(6)}`;
                return `<a href="https://wa.me/521${cleanPhone}" class="phone-link" target="_blank">${formatted}</a>`;
            }
            
            return phone;
        }
        
        // Aplicar restricciones según el tipo de usuario
        function applyUserRestrictions() {
            if (currentUser === 'Ventas') {
                // Ocultar o deshabilitar elementos de edición/eliminación
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.style.display = 'none';
                });
                
                // Deshabilitar exportación para Ventas
                document.querySelectorAll('.export-btn').forEach(btn => {
                    btn.classList.add('restricted-action');
                });
                
                // Ocultar pestaña de logs
                document.querySelector('.tab[onclick="switchTab(\'logs\')"]').style.display = 'none';
                
                // Cambiar texto para indicar modo de solo lectura
                document.querySelector('h1').textContent += ' (Modo Ventas)';
            } else if (currentUser === 'Arturo') {
                // Mostrar pestaña de logs para administrador
                document.querySelector('.tab[onclick="switchTab(\'logs\')"]').style.display = 'flex';
            }
        }
        
        // Permitir login al presionar Enter
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkLogin();
            }
        });
        
        // Función para registrar una nueva reparación
        function addItem() {
            const customerName = customerNameInput.value.trim();
            const customerPhone = customerPhoneInput.value.trim();
            const model = itemNameInput.value.trim();
            const serialNumber = serialNumberInput.value.trim();
            const price = parseFloat(repairCostInput.value);
            const salesPerson = salesPersonInput.value.trim();
            const saleDate = saleDateInput.value;
            const status = repairStatusInput.value;
            const notes = repairNotesInput.value.trim();
            commissionRate = parseFloat(commissionRateInput.value);
            
            if (!customerName || !model || isNaN(price) || price < 0 || !salesPerson || !saleDate) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }
            
            const commission = price * (commissionRate / 100);
            
            // Crear registro de reparación
            const saleRecord = {
                id: Date.now(),
                date: saleDate,
                customerName: customerName,
                customerPhone: customerPhone,
                model: model,
                serialNumber: serialNumber,
                price: price,
                commissionRate: commissionRate,
                commission: commission,
                salesPerson: salesPerson,
                status: status,
                notes: notes,
                lastUpdated: new Date().toISOString(),
                registeredBy: currentUser
            };
            
            // Agregar al Historial
            salesHistory.push(saleRecord);
            saveToLocalStorage();
            
            // Registrar actividad
            logActivity('NUEVA REPARACIÓN', `Cliente: ${customerName}, Modelo: ${model}, Costo: $${price.toFixed(2)}`, 'info');
            
            // Actualizar la interfaz
            loadSalesHistory();
            updateSummary();
            loadPendingNotes();
            updateCharts();
            loadMonthlyServices();
            
            // Limpiar campos
            customerNameInput.value = '';
            customerPhoneInput.value = '';
            itemNameInput.value = '';
            serialNumberInput.value = '';
            serialNumberOption.value = 'has';
            serialNumberInput.disabled = false;
            repairCostInput.value = '';
            salesPersonInput.value = '';
            repairNotesInput.value = '';
            customerNameInput.focus();
            
            alert(`Registro exitoso!\nCliente: ${customerName}\nModelo: ${model}\nEstado: ${getStatusText(status)}`);
        }
        
        // Función para cargar el Historial
        function loadSalesHistory() {
            historyTableBody.innerHTML = '';
            const searchTerm = searchInput.value.toLowerCase();
            
            const filteredSales = salesHistory.filter(sale => 
                sale.customerName.toLowerCase().includes(searchTerm) ||
                (sale.customerPhone && sale.customerPhone.toLowerCase().includes(searchTerm)) ||
                sale.model.toLowerCase().includes(searchTerm) || 
                sale.salesPerson.toLowerCase().includes(searchTerm) ||
                sale.status.toLowerCase().includes(searchTerm)
            );
            
            if (filteredSales.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="9" style="text-align: center;">No se encontraron registros</td>';
                historyTableBody.appendChild(row);
                return;
            }
            
            filteredSales.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            filteredSales.forEach(sale => {
                const row = document.createElement('tr');
                row.className = `status-${sale.status}`;
                
                const dateCell = document.createElement('td');
                dateCell.textContent = formatDate(sale.date);
                
                const customerCell = document.createElement('td');
                customerCell.textContent = sale.customerName;
                
                const phoneCell = document.createElement('td');
                phoneCell.innerHTML = formatPhoneNumber(sale.customerPhone) || 'N/A';
                
                const modelCell = document.createElement('td');
                modelCell.textContent = sale.model;
                
                const priceCell = document.createElement('td');
                priceCell.textContent = '$' + sale.price.toFixed(2);
                
                const commissionCell = document.createElement('td');
                commissionCell.textContent = '$' + sale.commission.toFixed(2);
                
                const salesPersonCell = document.createElement('td');
                salesPersonCell.textContent = sale.salesPerson;
                
                const statusCell = document.createElement('td');
                statusCell.textContent = getStatusText(sale.status);
                
                const actionCell = document.createElement('td');
                actionCell.className = 'action-buttons';
                
                const notesBtn = document.createElement('button');
                notesBtn.innerHTML = '<i class="fas fa-edit"></i> Notas';
                notesBtn.className = 'notes-btn';
                notesBtn.addEventListener('click', () => openNotesModal(sale.id));
                
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Eliminar';
                deleteBtn.className = 'delete-btn';
                deleteBtn.addEventListener('click', () => deleteSale(sale.id));
                
                // Aplicar restricciones si el usuario es Ventas
                if (currentUser === 'Ventas') {
                    deleteBtn.style.display = 'none';
                    notesBtn.classList.add('restricted-action');
                }
                
                actionCell.appendChild(notesBtn);
                actionCell.appendChild(deleteBtn);
                
                row.appendChild(dateCell);
                row.appendChild(customerCell);
                row.appendChild(phoneCell);
                row.appendChild(modelCell);
                row.appendChild(priceCell);
                row.appendChild(commissionCell);
                row.appendChild(salesPersonCell);
                row.appendChild(statusCell);
                row.appendChild(actionCell);
                
                historyTableBody.appendChild(row);
            });
        }
        
        // Función para cargar servicios por mes
        function loadMonthlyServices() {
            monthlyServicesContainer.innerHTML = '';
            
            if (salesHistory.length === 0) {
                monthlyServicesContainer.innerHTML = '<p>No hay registros de servicios</p>';
                return;
            }
            
            // Agrupar por mes y año
            const monthlyGroups = {};
            
            salesHistory.forEach(sale => {
                const date = new Date(sale.date);
                const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthYearLabel = `${getMonthName(date.getMonth())} ${date.getFullYear()}`;
                
                if (!monthlyGroups[monthYear]) {
                    monthlyGroups[monthYear] = {
                        label: monthYearLabel,
                        services: [],
                        total: 0,
                        completed: 0,
                        pending: 0,
                        repair: 0
                    };
                }
                
                monthlyGroups[monthYear].services.push(sale);
                monthlyGroups[monthYear].total += sale.price;
                
                if (sale.status === 'completed') {
                    monthlyGroups[monthYear].completed++;
                } else if (sale.status === 'pending') {
                    monthlyGroups[monthYear].pending++;
                } else if (sale.status === 'repair') {
                    monthlyGroups[monthYear].repair++;
                }
            });
            
            // Ordenar de más reciente a más antiguo
            const sortedMonths = Object.keys(monthlyGroups).sort().reverse();
            
            if (sortedMonths.length === 0) {
                monthlyServicesContainer.innerHTML = '<p>No hay registros de servicios</p>';
                return;
            }
            
            sortedMonths.forEach(monthKey => {
                const monthData = monthlyGroups[monthKey];
                const monthCard = document.createElement('div');
                monthCard.className = 'monthly-service-card';
                
                const header = document.createElement('div');
                header.className = 'monthly-service-header';
                
                const title = document.createElement('div');
                title.className = 'monthly-service-title';
                title.textContent = monthData.label;
                
                const total = document.createElement('div');
                total.className = 'monthly-service-total';
                total.textContent = `Total: $${monthData.total.toFixed(2)}`;
                
                header.appendChild(title);
                header.appendChild(total);
                
                const stats = document.createElement('div');
                stats.style.margin = '10px 0';
                stats.innerHTML = `
                    <p><i class="fas fa-check-circle" style="color: #4CAF50;"></i> Completados: ${monthData.completed} | 
                    <i class="fas fa-clock" style="color: #FF9800;"></i> Pendientes: ${monthData.pending} | 
                    <i class="fas fa-tools" style="color: #f44336;"></i> En Reparación: ${monthData.repair}</p>
                `;
                
                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Modelo</th>
                            <th>Técnico</th>
                            <th>Costo</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${monthData.services
                            .sort((a, b) => new Date(b.date) - new Date(a.date))
                            .map(sale => `
                                <tr class="status-${sale.status}">
                                    <td>${formatDate(sale.date)}</td>
                                    <td>${sale.customerName}</td>
                                    <td>${sale.model}</td>
                                    <td>${sale.salesPerson}</td>
                                    <td>$${sale.price.toFixed(2)}</td>
                                    <td>${getStatusText(sale.status)}</td>
                                </tr>
                            `)
                            .join('')}
                    </tbody>
                `;
                
                monthCard.appendChild(header);
                monthCard.appendChild(stats);
                monthCard.appendChild(table);
                
                monthlyServicesContainer.appendChild(monthCard);
            });
        }
        
        // Función para cargar notas pendientes
        function loadPendingNotes() {
            pendingRepairsDiv.innerHTML = '';
            const searchTerm = searchNotesInput.value.toLowerCase();
            
            const pendingItems = salesHistory.filter(sale => 
                sale.status !== 'completed' && 
                (sale.customerName.toLowerCase().includes(searchTerm) ||
                (sale.customerPhone && sale.customerPhone.toLowerCase().includes(searchTerm)) ||
                sale.model.toLowerCase().includes(searchTerm) || 
                (sale.notes && sale.notes.toLowerCase().includes(searchTerm)) ||
                sale.salesPerson.toLowerCase().includes(searchTerm))
            );
            
            if (pendingItems.length === 0) {
                pendingRepairsDiv.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">No hay reparaciones pendientes</p>';
                return;
            }
            
            pendingItems.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            pendingItems.forEach(item => {
                const card = document.createElement('div');
                card.className = `pending-card ${item.status}`;
                
                // Header con título y estado
                const header = document.createElement('div');
                header.className = 'card-header';
                
                const title = document.createElement('h4');
                title.className = 'card-title';
                title.textContent = item.model;
                
                const status = document.createElement('span');
                status.className = `card-status status-${item.status}`;
                status.textContent = getStatusText(item.status);
                
                header.appendChild(title);
                header.appendChild(status);
                
                // Detalles
                const details = document.createElement('div');
                details.className = 'card-details';
                details.innerHTML = `
                    <p><i class="fas fa-user"></i> <strong>Cliente:</strong> ${item.customerName}</p>
                    <p><i class="fas fa-phone"></i> <strong>Teléfono:</strong> ${formatPhoneNumber(item.customerPhone) || 'N/A'}</p>
                    <p><i class="fas fa-calendar-alt"></i> <strong>Fecha:</strong> ${formatDate(item.date)}</p>
                    <p><i class="fas fa-user-tie"></i> <strong>Técnico:</strong> ${item.salesPerson}</p>
                    <p><i class="fas fa-dollar-sign"></i> <strong>Costo:</strong> $${item.price.toFixed(2)}</p>
                `;
                
                // Notas
                const notes = document.createElement('div');
                notes.className = 'card-notes';
                notes.innerHTML = `<i class="fas fa-sticky-note"></i> ${item.notes || 'Sin notas registradas'}`;
                
                // Acciones
                const actions = document.createElement('div');
                actions.className = 'card-actions';
                
                const editBtn = document.createElement('button');
                editBtn.innerHTML = '<i class="fas fa-edit"></i> Editar';
                editBtn.className = 'notes-btn';
                editBtn.addEventListener('click', () => openNotesModal(item.id));
                
                const completeBtn = document.createElement('button');
                completeBtn.innerHTML = '<i class="fas fa-check-circle"></i> Completar';
                completeBtn.style.backgroundColor = '#4CAF50';
                completeBtn.style.color = 'white';
                completeBtn.addEventListener('click', () => markAsCompleted(item.id));
                
                // Aplicar restricciones si el usuario es Ventas
                if (currentUser === 'Ventas') {
                    editBtn.classList.add('restricted-action');
                    completeBtn.classList.add('restricted-action');
                }
                
                actions.appendChild(editBtn);
                if (item.status !== 'completed') {
                    actions.appendChild(completeBtn);
                }
                
                // Construir la tarjeta
                card.appendChild(header);
                card.appendChild(details);
                card.appendChild(notes);
                card.appendChild(actions);
                
                pendingRepairsDiv.appendChild(card);
            });
        }
        
        // Función mejorada para cargar el inventario
        function loadInventory() {
            const searchTerm = searchInventoryInput.value.toLowerCase();
            const categoryFilterValue = categoryFilter.value;
            const stockFilterValue = stockFilter.value;
            
            // Filtrar items
            const filteredItems = inventory.filter(item => {
                // Filtro por búsqueda
                const matchesSearch = 
                    item.name.toLowerCase().includes(searchTerm) ||
                    item.category.toLowerCase().includes(searchTerm) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm)) ||
                    (item.code && item.code.toLowerCase().includes(searchTerm));
                
                // Filtro por categoría
                const matchesCategory = !categoryFilterValue || item.category === categoryFilterValue;
                
                // Filtro por stock
                let matchesStock = true;
                if (stockFilterValue === 'low') {
                    matchesStock = item.quantity > 0 && item.quantity < item.minStock;
                } else if (stockFilterValue === 'critical') {
                    matchesStock = item.quantity > 0 && item.quantity < (item.minStock * 0.5);
                } else if (stockFilterValue === 'out') {
                    matchesStock = item.quantity === 0;
                }
                
                return matchesSearch && matchesCategory && matchesStock;
            });
            
            inventoryTableBody.innerHTML = '';
            
            if (filteredItems.length === 0) {
                inventoryTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No se encontraron items en inventario</td></tr>';
                updateInventorySummary();
                return;
            }
            
            // Ordenar por nombre
            filteredItems.sort((a, b) => a.name.localeCompare(b.name));
            
            // Variables para el resumen
            let totalItems = 0;
            let lowStockItems = 0;
            let criticalStockItems = 0;
            let outOfStockItems = 0;
            let totalInventoryValue = 0;
            
            filteredItems.forEach(item => {
                totalItems++;
                totalInventoryValue += item.quantity * item.price;
                
                // Calcular estado del stock
                let stockStatus = 'normal';
                if (item.quantity === 0) {
                    stockStatus = 'out';
                    outOfStockItems++;
                } else if (item.quantity < (item.minStock * 0.5)) {
                    stockStatus = 'critical';
                    criticalStockItems++;
                } else if (item.quantity < item.minStock) {
                    stockStatus = 'low';
                    lowStockItems++;
                }
                
                // Calcular porcentaje de stock
                const stockPercentage = item.minStock > 0 ? 
                    Math.min(100, Math.round((item.quantity / item.minStock) * 100)) : 100;
                
                const row = document.createElement('tr');
                row.className = `inventory-item ${stockStatus}-stock`;
                
                const nameCell = document.createElement('td');
                nameCell.textContent = item.name;
                nameCell.title = item.description || 'Sin descripción';
                
                const categoryCell = document.createElement('td');
                categoryCell.textContent = getCategoryName(item.category);
                
                const quantityCell = document.createElement('td');
                quantityCell.textContent = item.quantity;
                
                const priceCell = document.createElement('td');
                priceCell.textContent = '$' + item.price.toFixed(2);
                
                const codeCell = document.createElement('td');
                codeCell.textContent = item.code || 'N/A';
                
                const minStockCell = document.createElement('td');
                minStockCell.textContent = item.minStock;
                
                const percentageCell = document.createElement('td');
                const percentageBar = document.createElement('div');
                percentageBar.className = 'percentage-bar-container';
                
                const percentageBarFill = document.createElement('div');
                percentageBarFill.className = 'percentage-bar-fill';
                percentageBarFill.style.width = `${stockPercentage}%`;
                percentageBarFill.style.backgroundColor = getPercentageColor(stockPercentage);
                
                const percentageText = document.createElement('span');
                percentageText.className = 'percentage-text';
                percentageText.textContent = `${stockPercentage}%`;
                
                percentageBar.appendChild(percentageBarFill);
                percentageBar.appendChild(percentageText);
                percentageCell.appendChild(percentageBar);
                
                const actionCell = document.createElement('td');
                actionCell.className = 'inventory-actions';
                
                const editBtn = createActionButton('fas fa-edit', 'Editar', 'btn-primary', () => openEditItemModal(item.id));
                const movementBtn = createActionButton('fas fa-exchange-alt', 'Movimiento', 'btn-info', () => openMovementModal(item.id));
                const deleteBtn = createActionButton('fas fa-trash-alt', 'Eliminar', 'btn-danger', () => deleteInventoryItem(item.id));
                
                actionCell.appendChild(editBtn);
                actionCell.appendChild(movementBtn);
                
                // Solo mostrar botón de eliminar para administradores
                if (currentUser === 'Arturo') {
                    actionCell.appendChild(deleteBtn);
                }
                
                row.appendChild(nameCell);
                row.appendChild(categoryCell);
                row.appendChild(quantityCell);
                row.appendChild(priceCell);
                row.appendChild(codeCell);
                row.appendChild(minStockCell);
                row.appendChild(percentageCell);
                row.appendChild(actionCell);
                
                inventoryTableBody.appendChild(row);
            });
            
            // Actualizar resumen
            updateInventorySummary(totalItems, lowStockItems, criticalStockItems, outOfStockItems, totalInventoryValue);
            
            // Cargar movimientos
            loadInventoryMovements();
        }
        
        // Función para crear botones de acción
        function createActionButton(iconClass, tooltip, btnClass, onClick) {
            const btn = document.createElement('button');
            btn.className = `btn btn-sm ${btnClass}`;
            btn.title = tooltip;
            
            const icon = document.createElement('i');
            icon.className = iconClass;
            
            btn.appendChild(icon);
            btn.addEventListener('click', onClick);
            return btn;
        }
        
        // Función para actualizar el resumen del inventario
        function updateInventorySummary(total = 0, low = 0, critical = 0, out = 0, value = 0) {
            document.getElementById('totalItems').textContent = total;
            document.getElementById('lowStockItems').textContent = low;
            document.getElementById('criticalStockItems').textContent = critical;
            document.getElementById('outOfStockItems').textContent = out;
            document.getElementById('totalInventoryValue').textContent = value.toFixed(2);
        }
        
        // Función mejorada para cargar movimientos de inventario
        function loadInventoryMovements() {
            const searchTerm = searchMovementsInput.value.toLowerCase();
            
            // Filtrar movimientos
            const filteredMovements = inventoryMovements.filter(movement => {
                const itemName = getItemName(movement.itemId)?.toLowerCase() || '';
                return (
                    itemName.includes(searchTerm) ||
                    movement.type.toLowerCase().includes(searchTerm) ||
                    movement.user.toLowerCase().includes(searchTerm) ||
                    (movement.notes && movement.notes.toLowerCase().includes(searchTerm))
                );
            });
            
            movementsTableBody.innerHTML = '';
            
            if (filteredMovements.length === 0) {
                movementsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No se encontraron movimientos</td></tr>';
                return;
            }
            
            // Ordenar por fecha (más reciente primero)
            filteredMovements.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Limitar a 100 movimientos para no sobrecargar la tabla
            const displayMovements = filteredMovements.slice(0, 100);
            
            displayMovements.forEach(movement => {
                const row = document.createElement('tr');
                row.className = `movement-${movement.type}`;
                
                const dateCell = document.createElement('td');
                dateCell.textContent = formatDateTime(movement.date);
                
                const itemCell = document.createElement('td');
                const itemName = getItemName(movement.itemId) || 'Item eliminado';
                itemCell.textContent = itemName;
                
                const typeCell = document.createElement('td');
                typeCell.textContent = getMovementTypeName(movement.type);
                
                const quantityCell = document.createElement('td');
                quantityCell.textContent = movement.quantity;
                quantityCell.className = movement.type === 'entrada' ? 'text-success' : 'text-danger';
                
                const userCell = document.createElement('td');
                userCell.textContent = movement.user;
                
                const notesCell = document.createElement('td');
                notesCell.textContent = movement.notes || 'N/A';
                
                const stockCell = document.createElement('td');
                if (movement.newQuantity !== undefined) {
                    stockCell.textContent = movement.newQuantity;
                } else {
                    // Calcular stock actual si no está registrado
                    const item = inventory.find(i => i.id === movement.itemId);
                    stockCell.textContent = item ? item.quantity : 'N/A';
                }
                
                row.appendChild(dateCell);
                row.appendChild(itemCell);
                row.appendChild(typeCell);
                row.appendChild(quantityCell);
                row.appendChild(userCell);
                row.appendChild(notesCell);
                row.appendChild(stockCell);
                
                movementsTableBody.appendChild(row);
            });
        }
        
        // Función para abrir modal de notas
        function openNotesModal(id) {
            const item = salesHistory.find(sale => sale.id === id);
            if (!item) return;
            
            currentEditingId = id;
            
            document.getElementById('modalTitle').textContent = `Notas: ${item.model}`;
            document.getElementById('modalCustomer').textContent = item.customerName;
            document.getElementById('modalPhone').textContent = formatPhoneNumber(item.customerPhone) || 'N/A';
            document.getElementById('modalModel').textContent = item.model;
            document.getElementById('modalSerial').textContent = item.serialNumber || 'N/A';
            document.getElementById('modalDate').textContent = formatDate(item.date);
            document.getElementById('modalTech').textContent = item.salesPerson;
            document.getElementById('modalCost').value = item.price;
            document.getElementById('modalStatus').value = item.status;
            document.getElementById('modalNotes').value = item.notes;
            
            // Aplicar restricciones si el usuario es Ventas
            if (currentUser === 'Ventas') {
                document.getElementById('modalStatus').disabled = true;
                document.getElementById('modalNotes').disabled = true;
                document.getElementById('modalCost').disabled = true;
                saveNotesBtn.classList.add('restricted-action');
            } else {
                document.getElementById('modalStatus').disabled = false;
                document.getElementById('modalNotes').disabled = false;
                document.getElementById('modalCost').disabled = false;
                saveNotesBtn.classList.remove('restricted-action');
            }
            
            modal.style.display = 'block';
        }
        
        // Función para abrir modal de agregar herramienta
        function openAddItemModal() {
            if (currentUser === 'Ventas') {
                alert('No tienes permisos para agregar herramientas');
                return;
            }
            
            currentInventoryItemId = null;
            document.getElementById('inventoryModalTitle').textContent = 'Agregar Herramienta';
            document.getElementById('itemNameInventory').value = '';
            document.getElementById('itemCategory').value = 'herramientas';
            document.getElementById('itemQuantity').value = 1;
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemCode').value = '';
            document.getElementById('itemDescription').value = '';
            document.getElementById('itemMinStock').value = 1;
            
            inventoryModal.style.display = 'block';
        }
        
        // Función para abrir modal de edición
        function openEditItemModal(itemId) {
            if (currentUser === 'Ventas') {
                alert('No tienes permisos para editar herramientas');
                return;
            }
            
            const item = inventory.find(i => i.id === itemId);
            if (!item) return;
            
            currentInventoryItemId = itemId;
            document.getElementById('inventoryModalTitle').textContent = 'Editar Herramienta';
            document.getElementById('itemNameInventory').value = item.name;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemQuantity').value = item.quantity;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemCode').value = item.code || '';
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('itemMinStock').value = item.minStock;
            
            inventoryModal.style.display = 'block';
        }
        
        // Función para abrir modal de movimiento
        function openMovementModal(itemId) {
            if (currentUser === 'Ventas') {
                alert('No tienes permisos para registrar movimientos');
                return;
            }
            
            const item = inventory.find(i => i.id === itemId);
            if (!item) return;
            
            currentInventoryItemId = itemId;
            document.getElementById('movementModalTitle').textContent = `Movimiento: ${item.name}`;
            document.getElementById('movementType').value = 'entrada';
            document.getElementById('movementQuantity').value = 1;
            document.getElementById('movementTechnician').value = '';
            document.getElementById('movementNotes').value = '';
            
            toggleMovementFields();
            movementModal.style.display = 'block';
        }
        
        // Función para alternar campos según tipo de movimiento
        function toggleMovementFields() {
            const movementType = document.getElementById('movementType').value;
            const technicianGroup = document.getElementById('movementTechnicianGroup');
            
            if (movementType === 'salida') {
                technicianGroup.style.display = 'block';
            } else {
                technicianGroup.style.display = 'none';
            }
        }
        
        // Función para mostrar estadísticas de inventario
        function showInventoryStats() {
            // Datos para gráficos
            const categories = {};
            const lowStockItems = [];
            
            inventory.forEach(item => {
                // Conteo por categoría
                categories[item.category] = (categories[item.category] || 0) + 1;
                
                // Items con stock bajo
                if (item.quantity < item.minStock) {
                    lowStockItems.push({
                        name: item.name,
                        quantity: item.quantity,
                        minStock: item.minStock,
                        percentage: Math.round((item.quantity / item.minStock) * 100)
                    });
                }
            });
            
            // Ordenar items con stock bajo
            lowStockItems.sort((a, b) => a.percentage - b.percentage);
            
            // Crear gráfico de categorías
            const categoryCtx = document.getElementById('inventoryCategoryChart').getContext('2d');
            
            if (inventoryCategoryChart) {
                inventoryCategoryChart.destroy();
            }
            
            inventoryCategoryChart = new Chart(categoryCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(categories).map(getCategoryName),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: [
                            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'
                        ],
                        hoverBackgroundColor: [
                            '#2e59d9', '#17a673', '#2c9faf', '#dda20a', '#be2617', '#656774'
                        ],
                        hoverBorderColor: "rgba(234, 236, 244, 1)",
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
            
            // Crear gráfico de stock bajo (top 10)
            const lowStockCtx = document.getElementById('inventoryLowStockChart').getContext('2d');
            const displayItems = lowStockItems.slice(0, 10);
            
            if (inventoryLowStockChart) {
                inventoryLowStockChart.destroy();
            }
            
            inventoryLowStockChart = new Chart(lowStockCtx, {
                type: 'bar',
                data: {
                    labels: displayItems.map(item => item.name),
                    datasets: [{
                        label: 'Stock Actual',
                        backgroundColor: '#e74a3b',
                        hoverBackgroundColor: '#be2617',
                        borderColor: '#e74a3b',
                        data: displayItems.map(item => item.quantity)
                    }, {
                        label: 'Stock Mínimo',
                        backgroundColor: '#f6c23e',
                        hoverBackgroundColor: '#dda20a',
                        borderColor: '#f6c23e',
                        data: displayItems.map(item => item.minStock)
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: false,
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Top 10 items más movidos
            const itemMovements = {};
            inventoryMovements.forEach(movement => {
                if (!itemMovements[movement.itemId]) {
                    itemMovements[movement.itemId] = {
                        name: getItemName(movement.itemId) || 'Item eliminado',
                        entradas: 0,
                        salidas: 0,
                        total: 0
                    };
                }
                
                if (movement.type === 'entrada') {
                    itemMovements[movement.itemId].entradas += movement.quantity;
                } else if (movement.type === 'salida') {
                    itemMovements[movement.itemId].salidas += movement.quantity;
                }
                
                itemMovements[movement.itemId].total++;
            });
            
            const sortedItems = Object.values(itemMovements)
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);
            
            const topMovedItemsBody = document.getElementById('topMovedItemsBody');
            topMovedItemsBody.innerHTML = '';
            
            sortedItems.forEach(item => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.textContent = item.name;
                
                const entradaCell = document.createElement('td');
                entradaCell.textContent = item.entradas;
                
                const salidaCell = document.createElement('td');
                salidaCell.textContent = item.salidas;
                
                const totalCell = document.createElement('td');
                totalCell.textContent = item.total;
                
                row.appendChild(nameCell);
                row.appendChild(entradaCell);
                row.appendChild(salidaCell);
                row.appendChild(totalCell);
                
                topMovedItemsBody.appendChild(row);
            });
            
            // Mostrar modal
            document.getElementById('inventoryStatsModal').style.display = 'block';
        }
        
        // Función para generar reporte PDF del inventario
        function generateInventoryReport() {
            if (currentUser === 'Ventas') {
                alert('No tienes permisos para generar reportes');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título
            doc.setFontSize(18);
            doc.setTextColor(40);
            doc.setFont('helvetica', 'bold');
            doc.text('Reporte de Inventario', 105, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setTextColor(100);
            doc.setFont('helvetica', 'normal');
            doc.text('R.R Electric Run Run', 105, 27, { align: 'center' });
            
            // Fecha de generación
            doc.setFontSize(10);
            doc.text(`Generado el: ${new Date().toLocaleDateString()} a las ${new Date().toLocaleTimeString()}`, 105, 35, { align: 'center' });
            
            // Resumen
            doc.setFontSize(12);
            doc.setTextColor(40);
            doc.text('Resumen del Inventario', 14, 45);
            
            const totalItems = inventory.length;
            const lowStockItems = inventory.filter(item => item.quantity > 0 && item.quantity < item.minStock).length;
            const criticalStockItems = inventory.filter(item => item.quantity > 0 && item.quantity < (item.minStock * 0.5)).length;
            const outOfStockItems = inventory.filter(item => item.quantity === 0).length;
            const totalInventoryValue = inventory.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            
            doc.setFontSize(11);
            doc.text(`Total de Items: ${totalItems}`, 20, 55);
            doc.text(`Items con Stock Bajo: ${lowStockItems}`, 20, 62);
            doc.text(`Items con Stock Crítico: ${criticalStockItems}`, 20, 69);
            doc.text(`Items Agotados: ${outOfStockItems}`, 20, 76);
            doc.text(`Valor Total del Inventario: $${totalInventoryValue.toFixed(2)}`, 20, 83);
            
            // Tabla de items
            doc.setFontSize(12);
            doc.setTextColor(40);
            doc.text('Items en Inventario', 105, 95, { align: 'center' });
            
            const headers = [
                ['Nombre', 'Categoría', 'Cantidad', 'Precio', 'Valor']
            ];
            
            // Ordenar por categoría y nombre
            const sortedInventory = [...inventory].sort((a, b) => {
                if (a.category === b.category) {
                    return a.name.localeCompare(b.name);
                }
                return a.category.localeCompare(b.category);
            });
            
            const data = sortedInventory.map(item => [
                item.name,
                getCategoryName(item.category),
                item.quantity,
                `$${item.price.toFixed(2)}`,
                `$${(item.quantity * item.price).toFixed(2)}`
            ]);
            
            doc.autoTable({
                startY: 100,
                head: headers,
                body: data,
                margin: { left: 14, right: 14 },
                styles: { 
                    fontSize: 8,
                    cellPadding: 3,
                    overflow: 'linebreak'
                },
                headStyles: {
                    fillColor: [70, 0, 137],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                columnStyles: {
                    0: { cellWidth: 50 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 20 },
                    3: { cellWidth: 20 },
                    4: { cellWidth: 25 }
                },
                didDrawPage: function(data) {
                    // Footer
                    doc.setFontSize(10);
                    doc.setTextColor(150);
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.text(
                            `Página ${i} de ${pageCount}`,
                            doc.internal.pageSize.getWidth() - 20,
                            doc.internal.pageSize.getHeight() - 10,
                            { align: 'right' }
                        );
                    }
                }
            });
            
            // Pie de página
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('© R.R Electric Run Run - Todos los derechos reservados', 105, doc.internal.pageSize.getHeight() - 5, { align: 'center' });
            
            // Guardar PDF
            doc.save(`reporte_inventario_${new Date().toISOString().slice(0,10)}.pdf`);
        }
        
        // Función para exportar inventario a CSV
        function exportInventoryToCSV() {
            if (currentUser === 'Ventas') {
                alert('No tienes permisos para exportar inventario');
                return;
            }
            
            if (inventory.length === 0) {
                alert('No hay datos de inventario para exportar');
                return;
            }
            
            let csv = 'Nombre,Categoría,Cantidad,Precio Unitario,Código,Stock Mínimo,Descripción,Valor Total\n';
            
            inventory.forEach(item => {
                const totalValue = item.quantity * item.price;
                csv += `"${item.name}","${getCategoryName(item.category)}",${item.quantity},${item.price.toFixed(2)},"${item.code || ''}",${item.minStock},"${item.description.replace(/"/g, '""')}",${totalValue.toFixed(2)}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `inventario_scooters_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Función para guardar cambios en las notas
        function saveNotesChanges() {
            if (currentUser === 'Ventas') {
                alert('No tienes permisos para editar registros');
                return;
            }
            
            const itemIndex = salesHistory.findIndex(sale => sale.id === currentEditingId);
            if (itemIndex === -1) return;
            
            const newPrice = parseFloat(document.getElementById('modalCost').value);
            if (isNaN(newPrice)) {
                alert('Por favor ingrese un costo válido');
                return;
            }
            
            const oldPrice = salesHistory[itemIndex].price;
            const oldStatus = salesHistory[itemIndex].status;
            const newStatus = document.getElementById('modalStatus').value;
            const newNotes = document.getElementById('modalNotes').value;
            
            salesHistory[itemIndex].price = newPrice;
            salesHistory[itemIndex].commission = newPrice * (salesHistory[itemIndex].commissionRate / 100);
            salesHistory[itemIndex].status = newStatus;
            salesHistory[itemIndex].notes = newNotes;
            salesHistory[itemIndex].lastUpdated = new Date().toISOString();
            
            // Registrar actividad
            let changes = [];
            if (oldPrice !== newPrice) {
                changes.push(`Precio modificado de $${oldPrice.toFixed(2)} a $${newPrice.toFixed(2)}`);
            }
            if (oldStatus !== newStatus) {
                changes.push(`Estado cambiado de ${getStatusText(oldStatus)} a ${getStatusText(newStatus)}`);
            }
            
            if (changes.length > 0) {
                logActivity('ACTUALIZACIÓN DE REPARACIÓN', `ID: ${currentEditingId}. ${changes.join(', ')}`, 'info');
            }
            
            saveToLocalStorage();
            loadSalesHistory();
            updateSummary();
            loadPendingNotes();
            updateCharts();
            loadMonthlyServices();
            modal.style.display = 'none';
        }
        
        // Función para guardar herramienta
        function saveInventoryItem() {
            const name = document.getElementById('itemNameInventory').value.trim();
            const category = document.getElementById('itemCategory').value;
            const quantity = parseInt(document.getElementById('itemQuantity').value);
            const price = parseFloat(document.getElementById('itemPrice').value);
            const code = document.getElementById('itemCode').value.trim();
            const description = document.getElementById('itemDescription').value.trim();
            const minStock = parseInt(document.getElementById('itemMinStock').value);
            
            if (!name || isNaN(quantity) || quantity < 0 || isNaN(price) || price < 0 || isNaN(minStock) || minStock < 0) {
                alert('Por favor complete todos los campos obligatorios con valores válidos');
                return;
            }
            
            if (currentInventoryItemId) {
                // Editar herramienta existente
                const itemIndex = inventory.findIndex(item => item.id === currentInventoryItemId);
                if (itemIndex === -1) return;
                
                const oldItem = inventory[itemIndex];
                let changes = [];
                
                // Registrar movimiento de ajuste si cambió la cantidad
                const oldQuantity = oldItem.quantity;
                if (quantity !== oldQuantity) {
                    const movement = {
                        id: Date.now(),
                        itemId: currentInventoryItemId,
                        type: 'ajuste',
                        quantity: Math.abs(quantity - oldQuantity),
                        previousQuantity: oldQuantity,
                        newQuantity: quantity,
                        date: new Date().toISOString(),
                        user: currentUser,
                        notes: `Ajuste manual de inventario. ${description ? 'Motivo: ' + description : ''}`
                    };
                    
                    inventoryMovements.push(movement);
                    saveInventoryMovementsToLocalStorage();
                    
                    changes.push(`Cantidad modificada de ${oldQuantity} a ${quantity}`);
                }
                
                if (oldItem.name !== name) {
                    changes.push(`Nombre cambiado de "${oldItem.name}" a "${name}"`);
                }
                if (oldItem.category !== category) {
                    changes.push(`Categoría cambiada de "${getCategoryName(oldItem.category)}" a "${getCategoryName(category)}"`);
                }
                if (oldItem.price !== price) {
                    changes.push(`Precio modificado de $${oldItem.price.toFixed(2)} a $${price.toFixed(2)}`);
                }
                if (oldItem.minStock !== minStock) {
                    changes.push(`Stock mínimo modificado de ${oldItem.minStock} a ${minStock}`);
                }
                
                inventory[itemIndex] = {
                    ...oldItem,
                    name,
                    category,
                    quantity,
                    price,
                    code,
                    description,
                    minStock
                };
                
                // Registrar actividad si hubo cambios
                if (changes.length > 0) {
                    logActivity('ACTUALIZACIÓN DE INVENTARIO', `Item ID: ${currentInventoryItemId}. ${changes.join(', ')}`, 'info');
                }
            } else {
                // Agregar nueva herramienta
                const newItem = {
                    id: Date.now(),
                    name,
                    category,
                    quantity,
                    price,
                    code,
                    description,
                    minStock,
                    created: new Date().toISOString(),
                    createdBy: currentUser
                };
                
                inventory.push(newItem);
                
                // Registrar movimiento inicial
                const movement = {
                    id: Date.now(),
                    itemId: newItem.id,
                    type: 'entrada',
                    quantity: quantity,
                    date: new Date().toISOString(),
                    user: currentUser,
                    notes: 'Entrada inicial de inventario'
                };
                
                inventoryMovements.push(movement);
                saveInventoryMovementsToLocalStorage();
                
                // Registrar actividad
                logActivity('NUEVO ITEM EN INVENTARIO', `Nombre: ${name}, Cantidad: ${quantity}, Categoría: ${getCategoryName(category)}`, 'info');
            }
            
            saveInventoryToLocalStorage();
            loadInventory();
            closeInventoryModal();
        }
        
        // Función para guardar movimiento
        function saveInventoryMovement() {
            const type = document.getElementById('movementType').value;
            let quantity = parseInt(document.getElementById('movementQuantity').value);
            const technician = document.getElementById('movementTechnician').value;
            const notes = document.getElementById('movementNotes').value.trim();
            
            if (isNaN(quantity)) {
                alert('Por favor ingrese una cantidad válida');
                return;
            }
            
            const itemIndex = inventory.findIndex(item => item.id === currentInventoryItemId);
            if (itemIndex === -1) return;
            
            const item = inventory[itemIndex];
            
            // Validar salida si no hay suficiente stock
            if (type === 'salida' && quantity > item.quantity) {
                alert(`No hay suficiente stock. Disponible: ${item.quantity}`);
                return;
            }
            
            // Validar técnico para salidas
            if (type === 'salida' && !technician) {
                alert('Por favor seleccione un técnico para registrar la salida');
                return;
            }
            
            // Actualizar cantidad en inventario
            const oldQuantity = item.quantity;
            let newQuantity;
            
            if (type === 'entrada') {
                newQuantity = oldQuantity + quantity;
            } else if (type === 'salida') {
                newQuantity = oldQuantity - quantity;
            } else {
                newQuantity = quantity; // Para ajustes
            }
            
            inventory[itemIndex].quantity = newQuantity;
            
            // Crear registro de movimiento
            const movement = {
                id: Date.now(),
                itemId: currentInventoryItemId,
                type,
                quantity,
                date: new Date().toISOString(),
                user: currentUser,
                notes: type === 'salida' ? `Salida para: ${technician}. ${notes}` : notes,
                newQuantity
            };
            
            inventoryMovements.push(movement);
            saveInventoryMovementsToLocalStorage();
            saveInventoryToLocalStorage();
            
            // Registrar actividad
            const actionText = type === 'entrada' ? 'ENTRADA' : type === 'salida' ? 'SALIDA' : 'AJUSTE';
            logActivity(
                `${actionText} DE INVENTARIO`, 
                `Item: ${item.name}, Cantidad: ${quantity}, Stock anterior: ${oldQuantity}, Nuevo stock: ${newQuantity}`,
                'info'
            );
            
            loadInventory();
            closeMovementModal();
        }
        
        // Función para marcar como completado
        function markAsCompleted(id) {
            if (currentUser === 'Ventas') {
                alert('No tienes permisos para modificar registros');
                return;
            }
            
            const itemIndex = salesHistory.findIndex(sale => sale.id === id);
            if (itemIndex === -1) return;
            
            const oldStatus = salesHistory[itemIndex].status;
            salesHistory[itemIndex].status = 'completed';
            salesHistory[itemIndex].lastUpdated = new Date().toISOString();
            
            // Registrar actividad
            logActivity(
                'REPARACIÓN COMPLETADA', 
                `ID: ${id}, Cliente: ${salesHistory[itemIndex].customerName}, Modelo: ${salesHistory[itemIndex].model}`,
                'info'
            );
            
            saveToLocalStorage();
            loadSalesHistory();
            updateSummary();
            loadPendingNotes();
            updateCharts();
            loadMonthlyServices();
        }
        
        // Función para eliminar un registro
        function deleteSale(id) {
            if (currentUser === 'Ventas') {
                alert('No tienes permisos para eliminar registros');
                return;
            }
            
            if (confirm('¿Está seguro que desea eliminar este registro permanentemente?')) {
                const saleIndex = salesHistory.findIndex(sale => sale.id === id);
                if (saleIndex === -1) return;
                
                const deletedSale = salesHistory[saleIndex];
                
                salesHistory = salesHistory.filter(sale => sale.id !== id);
                saveToLocalStorage();
                
                // Registrar actividad
                logActivity(
                    'ELIMINACIÓN DE REPARACIÓN', 
                    `ID: ${id}, Cliente: ${deletedSale.customerName}, Modelo: ${deletedSale.model}`,
                    'warning'
                );
                
                loadSalesHistory();
                updateSummary();
                loadPendingNotes();
                updateCharts();
                loadMonthlyServices();
            }
        }
        
        // Función para eliminar herramienta
        function deleteInventoryItem(itemId) {
            if (currentUser === 'Ventas') {
                alert('No tienes permisos para eliminar herramientas');
                return;
            }
            
            if (confirm('¿Está seguro que desea eliminar esta herramienta del inventario? Todos los movimientos asociados permanecerán pero no se podrá identificar la herramienta.')) {
                const itemIndex = inventory.findIndex(item => item.id === itemId);
                if (itemIndex === -1) return;
                
                const deletedItem = inventory[itemIndex];
                
                inventory = inventory.filter(item => item.id !== itemId);
                saveInventoryToLocalStorage();
                
                // Registrar actividad
                logActivity(
                    'ELIMINACIÓN DE ITEM DE INVENTARIO', 
                    `Nombre: ${deletedItem.name}, Cantidad eliminada: ${deletedItem.quantity}`,
                    'warning'
                );
                
                loadInventory();
            }
        }
        
        // Función para exportar a CSV
        function exportToCSV() {
            if (currentUser === 'Ventas') {
                alert('No tienes permisos para exportar datos');
                return;
            }
            
            if (salesHistory.length === 0) {
                alert('No hay datos para exportar');
                return;
            }
            
            let csv = 'Fecha,Cliente,Teléfono,Modelo,Número de Serie,Costo,Comisión %,Comisión,Técnico,Estado,Notas,Última Actualización,Registrado por\n';
            
            salesHistory.forEach(sale => {
                csv += `"${formatDate(sale.date)}","${sale.customerName}","${sale.customerPhone || ''}","${sale.model}","${sale.serialNumber || 'N/A'}",${sale.price},${sale.commissionRate}%,${sale.commission},"${sale.salesPerson}","${getStatusText(sale.status)}","${sale.notes.replace(/"/g, '""')}","${new Date(sale.lastUpdated).toLocaleString()}","${sale.registeredBy || 'N/A'}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `registro_scooters_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Registrar actividad
            logActivity('EXPORTACIÓN DE DATOS', 'Exportación a CSV del historial de reparaciones', 'info');
        }
        
        // Función para exportar a PDF
        function exportToPDF() {
            if (currentUser === 'Ventas') {
                alert('No tienes permisos para exportar datos');
                return;
            }
            
            if (salesHistory.length === 0) {
                alert('No hay datos para exportar');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Logo (opcional)
            // doc.addImage(logoData, 'PNG', 10, 10, 50, 15);
            
            // Título
            doc.setFontSize(18);
            doc.setTextColor(40);
            doc.setFont('helvetica', 'bold');
            doc.text('Resumen de Reparaciones', 105, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setTextColor(100);
            doc.setFont('helvetica', 'normal');
            doc.text('R.R Electric Run Run', 105, 27, { align: 'center' });
            
            // Fecha de generación
            doc.setFontSize(10);
            doc.text(`Generado el: ${new Date().toLocaleDateString()} a las ${new Date().toLocaleTimeString()}`, 105, 35, { align: 'center' });
            
            // Totales
            doc.setFontSize(12);
            doc.setTextColor(40);
            doc.text('Resumen General', 14, 45);
            
            const totalSales = salesHistory.reduce((sum, sale) => sum + sale.price, 0);
            const totalCommissions = salesHistory.reduce((sum, sale) => sum + sale.commission, 0);
            const completedCount = salesHistory.filter(sale => sale.status === 'completed').length;
            const pendingCount = salesHistory.filter(sale => sale.status === 'pending').length;
            const repairCount = salesHistory.filter(sale => sale.status === 'repair').length;
            
            doc.setFontSize(11);
            doc.text(`Total Reparaciones: $${totalSales.toFixed(2)}`, 20, 55);
            doc.text(`Total Comisiones: $${totalCommissions.toFixed(2)}`, 20, 62);
            doc.text(`Scooters Atendidos: ${salesHistory.length}`, 20, 69);
            doc.text(`Completados: ${completedCount}`, 20, 76);
            doc.text(`Pendientes: ${pendingCount}`, 70, 76);
            doc.text(`En Reparación: ${repairCount}`, 120, 76);
            
            // Tabla de reparaciones
            doc.setFontSize(12);
            doc.setTextColor(40);
            doc.text('Últimas Reparaciones Registradas', 105, 95, { align: 'center' });
            
            const headers = [
                ['Fecha', 'Cliente', 'Modelo', 'Costo', 'Estado']
            ];
            
            const data = salesHistory
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 20)
                .map(sale => [
                    formatDate(sale.date),
                    sale.customerName,
                    sale.model,
                    `$${sale.price.toFixed(2)}`,
                    getStatusText(sale.status)
                ]);
            
            doc.autoTable({
                startY: 100,
                head: headers,
                body: data,
                margin: { left: 14, right: 14 },
                styles: { 
                    fontSize: 8,
                    cellPadding: 3,
                    overflow: 'linebreak'
                },
                headStyles: {
                    fillColor: [70, 0, 137], // Color morado similar al fondo
                    textColor: 255,
                    fontStyle: 'bold'
                },
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 40 },
                    3: { cellWidth: 20 },
                    4: { cellWidth: 25 }
                },
                didDrawPage: function(data) {
                    // Footer
                    doc.setFontSize(10);
                    doc.setTextColor(150);
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.text(
                            `Página ${i} de ${pageCount}`,
                            doc.internal.pageSize.getWidth() - 20,
                            doc.internal.pageSize.getHeight() - 10,
                            { align: 'right' }
                        );
                    }
                }
            });
            
            // Pie de página
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('© R.R Electric Run Run - Todos los derechos reservados', 105, doc.internal.pageSize.getHeight() - 5, { align: 'center' });
            
            // Guardar PDF
            doc.save(`resumen_reparaciones_${new Date().toISOString().slice(0,10)}.pdf`);
            
            // Registrar actividad
            logActivity('EXPORTACIÓN DE DATOS', 'Exportación a PDF del historial de reparaciones', 'info');
        }
        
        // Función para actualizar el resumen
        function updateSummary() {
            // Totales generales
            const totalSales = salesHistory.reduce((sum, sale) => sum + sale.price, 0);
            const totalCommissions = salesHistory.reduce((sum, sale) => sum + sale.commission, 0);
            const completedCount = salesHistory.filter(sale => sale.status === 'completed').length;
            const pendingCount = salesHistory.filter(sale => sale.status === 'pending').length;
            const repairCount = salesHistory.filter(sale => sale.status === 'repair').length;
            
            // Contar clientes únicos
            const uniqueCustomers = new Set(salesHistory.map(sale => sale.customerName)).size;
            
            document.getElementById('totalSales').textContent = totalSales.toFixed(2);
            document.getElementById('totalCommissions').textContent = totalCommissions.toFixed(2);
            document.getElementById('totalUnits').textContent = salesHistory.length;
            document.getElementById('totalCustomers').textContent = uniqueCustomers;
            document.getElementById('completedCount').textContent = completedCount;
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('repairCount').textContent = repairCount;
            
            // Resumen por técnico
            const salesByPerson = {};
            salesHistory.forEach(sale => {
                if (!salesByPerson[sale.salesPerson]) {
                    salesByPerson[sale.salesPerson] = {
                        sales: 0,
                        commissions: 0,
                        customers: new Set()
                    };
                }
                salesByPerson[sale.salesPerson].sales += sale.price;
                salesByPerson[sale.salesPerson].commissions += sale.commission;
                salesByPerson[sale.salesPerson].customers.add(sale.customerName);
            });
            
            const salesByPersonBody = document.getElementById('salesByPersonBody');
            salesByPersonBody.innerHTML = '';
            
            for (const [person, data] of Object.entries(salesByPerson)) {
                const row = document.createElement('tr');
                
                const personCell = document.createElement('td');
                personCell.textContent = person;
                
                const salesCell = document.createElement('td');
                salesCell.textContent = '$' + data.sales.toFixed(2);
                
                const commissionsCell = document.createElement('td');
                commissionsCell.textContent = '$' + data.commissions.toFixed(2);
                
                const customersCell = document.createElement('td');
                customersCell.textContent = data.customers.size;
                
                row.appendChild(personCell);
                row.appendChild(salesCell);
                row.appendChild(commissionsCell);
                row.appendChild(customersCell);
                
                salesByPersonBody.appendChild(row);
            }
            
            // Resumen por modelo
            const salesByModel = {};
            salesHistory.forEach(sale => {
                if (!salesByModel[sale.model]) {
                    salesByModel[sale.model] = {
                        units: 0,
                        total: 0
                    };
                }
                salesByModel[sale.model].units += 1;
                salesByModel[sale.model].total += sale.price;
            });
            
            const salesByModelBody = document.getElementById('salesByModelBody');
            salesByModelBody.innerHTML = '';
            
            for (const [model, data] of Object.entries(salesByModel)) {
                const row = document.createElement('tr');
                
                const modelCell = document.createElement('td');
                modelCell.textContent = model;
                
                const unitsCell = document.createElement('td');
                unitsCell.textContent = data.units;
                
                const totalCell = document.createElement('td');
                totalCell.textContent = '$' + data.total.toFixed(2);
                
                row.appendChild(modelCell);
                row.appendChild(unitsCell);
                row.appendChild(totalCell);
                
                salesByModelBody.appendChild(row);
            }
        }
        
        // Función para actualizar gráficos
        function updateCharts() {
            if (salesHistory.length === 0) return;
            
            // Datos para gráficos
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            // Datos semanales (últimas 8 semanas)
            const weeklyData = Array(8).fill(0);
            const weeklyLabels = [];
            
            for (let i = 7; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - (i * 7));
                weeklyLabels.push(`Sem ${date.getWeek()}`);
                
                const weekStart = new Date(date);
                weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                weeklyData[7 - i] = salesHistory.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= weekStart && saleDate <= weekEnd;
                }).length;
            }
            
            // Datos mensuales (últimos 6 meses)
            const monthlyData = Array(6).fill(0);
            const monthlyLabels = [];
            
            for (let i = 5; i >= 0; i--) {
                const month = (currentMonth - i + 12) % 12;
                const year = currentYear - Math.floor((i - currentMonth) / 12);
                monthlyLabels.push(`${getMonthName(month)} ${year}`);
                
                monthlyData[5 - i] = salesHistory.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate.getMonth() === month && saleDate.getFullYear() === year;
                }).length;
            }
            
            // Datos por estado
            const statusData = [
                salesHistory.filter(sale => sale.status === 'completed').length,
                salesHistory.filter(sale => sale.status === 'pending').length,
                salesHistory.filter(sale => sale.status === 'repair').length
            ];
            
            // Datos por modelo (top 5)
            const modelsCount = {};
            salesHistory.forEach(sale => {
                modelsCount[sale.model] = (modelsCount[sale.model] || 0) + 1;
            });
            
            const sortedModels = Object.entries(modelsCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const modelsLabels = sortedModels.map(m => m[0]);
            const modelsData = sortedModels.map(m => m[1]);
            
            // Crear/actualizar gráficos
            if (!weeklyChart) {
                weeklyChart = new Chart(
                    document.getElementById('weeklyChart'),
                    {
                        type: 'bar',
                        data: {
                            labels: weeklyLabels,
                            datasets: [{
                                label: 'Reparaciones por Semana',
                                data: weeklyData,
                                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    precision: 0
                                }
                            }
                        }
                    }
                );
            } else {
                weeklyChart.data.labels = weeklyLabels;
                weeklyChart.data.datasets[0].data = weeklyData;
                weeklyChart.update();
            }
            
            if (!monthlyChart) {
                monthlyChart = new Chart(
                    document.getElementById('monthlyChart'),
                    {
                        type: 'bar',
                        data: {
                            labels: monthlyLabels,
                            datasets: [{
                                label: 'Reparaciones por Mes',
                                data: monthlyData,
                                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    precision: 0
                                }
                            }
                        }
                    }
                );
            } else {
                monthlyChart.data.labels = monthlyLabels;
                monthlyChart.data.datasets[0].data = monthlyData;
                monthlyChart.update();
            }
            
            if (!statusChart) {
                statusChart = new Chart(
                    document.getElementById('statusChart'),
                    {
                        type: 'pie',
                        data: {
                            labels: ['Completados', 'Pendientes', 'En Reparación'],
                            datasets: [{
                                data: statusData,
                                backgroundColor: [
                                    'rgba(75, 192, 75, 0.5)',
                                    'rgba(255, 206, 86, 0.5)',
                                    'rgba(255, 99, 132, 0.5)'
                                ],
                                borderColor: [
                                    'rgba(75, 192, 75, 1)',
                                    'rgba(255, 206, 86, 1)',
                                    'rgba(255, 99, 132, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    }
                );
            } else {
                statusChart.data.datasets[0].data = statusData;
                statusChart.update();
            }
            
            if (!modelsChart) {
                modelsChart = new Chart(
                    document.getElementById('modelsChart'),
                    {
                        type: 'bar',
                        data: {
                            labels: modelsLabels,
                            datasets: [{
                                label: 'Reparaciones por Modelo',
                                data: modelsData,
                                backgroundColor: 'rgba(153, 102, 255, 0.5)',
                                borderColor: 'rgba(153, 102, 255, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    precision: 0
                                }
                            }
                        }
                    }
                );
            } else {
                modelsChart.data.labels = modelsLabels;
                modelsChart.data.datasets[0].data = modelsData;
                modelsChart.update();
            }
        }
        
        // Función para obtener nombre del mes
        function getMonthName(monthIndex) {
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            return months[monthIndex];
        }
        
        // Función para obtener nombre de categoría
        function getCategoryName(categoryKey) {
            const categories = {
                'herramientas': 'Herramientas',
                'refacciones': 'Refacciones',
                'consumibles': 'Consumibles',
                'electronicos': 'Componentes Electrónicos',
                'otros': 'Otros'
            };
            return categories[categoryKey] || categoryKey;
        }
        
        // Función para obtener nombre de tipo de movimiento
        function getMovementTypeName(type) {
            const types = {
                'entrada': 'Entrada',
                'salida': 'Salida',
                'ajuste': 'Ajuste'
            };
            return types[type] || type;
        }
        
        // Función para obtener nombre de herramienta por ID
        function getItemName(itemId) {
            const item = inventory.find(i => i.id === itemId);
            return item ? item.name : null;
        }
        
        // Función para obtener color según porcentaje de stock
        function getPercentageColor(percentage) {
            if (percentage < 25) return '#e74a3b';
            if (percentage < 50) return '#f6c23e';
            if (percentage < 75) return '#36b9cc';
            return '#1cc88a';
        }
        
        // Función para formatear fecha y hora
        function formatDateTime(dateString) {
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return new Date(dateString).toLocaleDateString('es-ES', options);
        }
        
        // Función para cerrar modal de inventario
        function closeInventoryModal() {
            inventoryModal.style.display = 'none';
        }
        
        // Función para cerrar modal de movimiento
        function closeMovementModal() {
            movementModal.style.display = 'none';
        }
        
        // Función para cerrar modal de estadísticas
        function closeInventoryStatsModal() {
            document.getElementById('inventoryStatsModal').style.display = 'none';
        }
        
        // Extender Date para obtener número de semana
        Date.prototype.getWeek = function() {
            const date = new Date(this.getTime());
            date.setHours(0, 0, 0, 0);
            date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
            const week1 = new Date(date.getFullYear(), 0, 4);
            return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        };
        
        // Función para guardar en localStorage
        function saveToLocalStorage() {
            localStorage.setItem('scooterSales', JSON.stringify(salesHistory));
        }
        
        // Función para guardar inventario en localStorage
        function saveInventoryToLocalStorage() {
            localStorage.setItem('scooterInventory', JSON.stringify(inventory));
        }
        
        // Función para guardar movimientos de inventario en localStorage
        function saveInventoryMovementsToLocalStorage() {
            localStorage.setItem('inventoryMovements', JSON.stringify(inventoryMovements));
        }
        
        // Función para cambiar entre pestañas
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
            
            if (tabId === 'historico') {
                loadSalesHistory();
            } else if (tabId === 'resumen') {
                updateSummary();
            } else if (tabId === 'notas') {
                loadPendingNotes();
            } else if (tabId === 'estadisticas') {
                updateCharts();
            } else if (tabId === 'mensual') {
                loadMonthlyServices();
            } else if (tabId === 'inventario') {
                loadInventory();
            } else if (tabId === 'logs') {
                if (currentUser === 'Arturo') {
                    loadLogs();
                } else {
                    alert('Solo el administrador puede acceder a los registros de actividad');
                    // Volver a la pestaña anterior
                    document.querySelector('.tab.active').click();
                    return;
                }
            }
        }
        
        // Función para formatear fecha
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('es-ES', options);
        }
        
        // Función para obtener texto de estado
        function getStatusText(status) {
            const statusText = {
                'completed': 'Completado',
                'pending': 'Pendiente',
                'repair': 'En Reparación'
            };
            return statusText[status] || status;
        }
        
        // Event listeners
        addItemBtn.addEventListener('click', addItem);
        searchInput.addEventListener('input', loadSalesHistory);
        searchNotesInput.addEventListener('input', loadPendingNotes);
        searchInventoryInput.addEventListener('input', loadInventory);
        searchMovementsInput.addEventListener('input', loadInventoryMovements);
        searchLogsInput.addEventListener('input', loadLogs);
        categoryFilter.addEventListener('change', loadInventory);
        stockFilter.addEventListener('change', loadInventory);
        closeModal.addEventListener('click', () => modal.style.display = 'none');
        
        // Cerrar modal al hacer clic fuera del contenido
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
            if (event.target === inventoryModal) {
                inventoryModal.style.display = 'none';
            }
            if (event.target === movementModal) {
                movementModal.style.display = 'none';
            }
            if (event.target === inventoryStatsModal) {
                inventoryStatsModal.style.display = 'none';
            }
        });
        
        // Inicializar campo de número de serie
        toggleSerialNumber();
    </script>
</body>
</html>
